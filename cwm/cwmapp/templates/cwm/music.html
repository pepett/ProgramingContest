{% extends "cwm/base.html" %}
{% load static %}
{% block title %}music{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/music.css' %}">
<main class="main-test">
        <!--ローディング画面ここから-->
        <link rel="stylesheet" href="{% static 'css/loading.css' %}">
        <div id="loading">
            <div class="logo">
                <img alt="CWM" src="{% static 'img/tmp/logo.png'%}">
                <span>Connect With Music</span>
            </div>
            <div class="fingerprint-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
        </div>
        <script src="{% static 'js/loading.js' %}"></script>
        <!--ここまで-->
        {% if request.user.userid == track_result.artists.0.id and request.user.is_authenticated %}
        <div class="layer js-modal">
            <div class="modal">
                <div class="modal__inner">
                    <div class="modal__contents">
                        <div class="modal__content">
                            <p class="warningbigtext">本当に削除しますか？</p>
                            <form class="deleteBox" action="{% url 'musdelete' track_result.id %}" method="post">
                                {% csrf_token %}
                                <input type="submit" name="MusDlt" class="deleteBT" id="submit" value="削除する">
                                <button type="button" class="loginBT" id="NotdeleteBT" value="delete">削除しない</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    <div class="music-main">
        {% if is_original %}
            <div id="original">
                <div class="original-track-name">
                    <p class="track-name">{{ track_result.name }}</p>
                </div>
                {% if request.user.userid == track_result.artists.0.id and request.user.is_authenticated %}
                <button type="submit" id="firstdeleteBT">曲を削除する</button>
                {% endif %}
                <img class="original-album-image" src="/media_local/{{ track_result.album.img.0.url }}" width="150" height="150">
                <audio src="/media_local/{{ track_result.full_url }}"></audio>
                <div id="seekbar"></div>
                <div id="Musictime">00:00</div>
                <button class="PlaySongBT" id="SongBT" type="button">
                        <img class="BTimg" src="{% static 'img/tmp/play_green.png' %}">
                </button>
            </div>
        {% else %}
            <div id="spotify-iframe"></div>
        {% endif %}
        <div class="likes">
            <div class="stars">
            </div>
            <div class="good">
            </div>
        </div>
        <div class="sharedesc">
            <div class="artist">
                <div class="album-name">
                    アルバム: <span class="album-title"><a href="{% url 'album' track_result.album.id %}">{{ track_result.album.name }}</a></span>
                </div>
                <div class="artist-name">
                    アーティスト: <span class="artist-title">
                        {% if is_original %}
                            <a href="{% url 'user' track_result.artists.0.id %}">{{ track_result.artists.0.name }}</a>
                        {% else %}
                            <a href="{% url 'artist' track_result.artists.0.id %}">{{ track_result.artists.0.name }}</a>
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="shere">
                <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-text="私は {{ track_result.name }} を聴いています" data-hashtags="cwm,{{ track_result.artists.0.name }}" data-size="large" data-lang="ja" data-show-count="false">Tweet</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                <div class="line-it-button" data-lang="ja" data-type="share-a" data-env="REAL" data-url="http://localhost:8000/index" data-color="default" data-size="large" data-count="false" data-ver="3" style="display: none;"></div>
                <script src="https://www.line-website.com/social-plugins/js/thirdparty/loader.
            min.js" async="async" defer="defer"></script>
            </div>
        </div>
        {% if tags %}
        <div class="tags">
            {% for t in tags %}
            <a href="{% url 'result' %}?search-music={{ t.tag_name }}">
                <div class="tag">
                    <span class="tag-name">#{{ t.tag_name }}</span>
                    <span class="tag-num">({{ t.tag_num }})</span>
                </div>
            </a>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    <div class="comments">
        {% if request.user.is_authenticated %}
            <form action="{% url 'create' track_result.id %}" method="post" id="create">
                {% csrf_token %}
                <div class="create-cmnt-box">
                    <textarea name="comment_text" cols="40" rows="10" required="" id="id_comment_text" placeholder="コメント"></textarea>
                    <div class="create-cmnt">
                        <input type="submit" name="submit" value="投稿" class="loginBT">
                    </div>
                </div>
            </form>
        {% endif %}
        <h2 id="c-title">コメント</h2>
        {% if is_comment %}
            {% for item in model %}
                <div class="comment-box">
                    <div class="cmt-top">
                        <div class="cmt-user">
                            <img src="{{ item.user_image.url }}" alt="ユーザの画像" width="50" height="50" style="border-radius: 50%;">
                            <div class="user-name">{{ item.user_name }}</div>
                        </div>
                        <div class="menu">
                            <span class="kebab">
                                <span class="kebab-ball"></span>
                                <span class="kebab-ball"></span>
                                <span class="kebab-ball"></span>
                            </span>
                        </div>
                    </div>
                    <div class="cmt-content">
                        <div class="good-img">
                            {% if item.is_good %}
                                <img src="{% static 'img/tmp/good_white.png' %}" alt="いいね" width="30" height="30" class="good-img-button" data-comment_id="{{ item.comment_id }}">
                            {% else %}
                                <img src="{% static 'img/tmp/good_black.png' %}" alt="いいね" width="30" height="30" class="good-img-button" data-comment_id="{{ item.comment_id }}">
                            {% endif %}
                            <span class="gc-count">{{ item.comment_good }}</span>
                        </div>
                        <div class="comment-text" id="c-{{ item.comment_id }}">{{ item.comment_text | linebreaks }}</div>
                    </div>
                    {% if request.user.userid == item.user_id and request.user.is_authenticated %}
                    <div class="forms">
                        <form action="{% url 'edit' track_result.id item.comment_id %}" method="post" class="edit-form" style="display: none;">
                            {% csrf_token %}
                            <textarea name="edit_content" cols="30" rows="10" class="edit_textarea">{{ item.comment_text }}</textarea>
                            <input type="submit" name="submit" value="変更" class="change-btn">
                        </form>
                        <div class="cmt-edit">
                            <form action="{% url 'delete' track_result.id item.comment_id %}" method="post" class="delete-form">
                                {% csrf_token %}
                                <input type="submit" name="submit" value="削除" class="del-btn">
                            </form>
                            <div class="edit-action">
                                <input type="button" class="edit-btn" value="編集">
                            </div>
                        </div>
                        <!-- </absolute> -->
                    </div>
                    {% else %}
                        <div class="forms">
                            <div class="cmt-edit"></div>
                            <div class="edit-action"></div>
                        </div>
                    {% endif %}
                    <!-- <replyform> -->
                    {% if request.user.is_authenticated %}
                        <form action="{% url 'create_reply' track_result.id item.comment_id %}" method="post" class="reply-form">
                            {% csrf_token %}
                            <div class="reply-box">
                                <textarea name="reply-text" class="reply-text" placeholder="返信を入力..."></textarea>
                            </div>
                            <div class="reply-box2">
                                <input type="submit" value="返信" class="reply-submit replyBT_off" disabled>
                            </div>
                        </form>
                    {% endif %}
                    <!-- </replyform> -->
                    <div class="reply">
                        <a href="" data-comment_id="{{ item.comment_id }}" class="a-reply">返信を見る</a>
                    </div>
                </div>
                <hr>
            {% endfor %}
        {% else %}
        <div class="comment-box">
            <h2 class="bigtext">コメントがありません</h2>
        </div>
        {% endif %}
    </div>
</main>

<script type="text/javascript">
    var PlayBTimg = "<img class='BTimg' src='{% static 'img/tmp/play_green.png' %}'>";
    var StopBTimg = "<img class='BTimg' src='{% static 'img/tmp/stop.png' %}'>";
</script>
<script src="https://open.spotify.com/embed-podcast/iframe-api/v1" async></script>
<script src="{% static 'js/index.js' %}"></script>
<script src="{% static 'js/music.js' %}"></script>
{% if is_original %}
<script>
    const audio = document.getElementsByTagName("audio")[0]
    const playButton = document.getElementById("SongBT")
    
    playButton.addEventListener('click', () => {
    if (audio.paused) {
        audio.play()
        playButton.innerHTML = playButton.innerHTML === StopBTimg ? PlayBTimg : StopBTimg
    } else {
        audio.pause()
        playButton.innerHTML = PlayBTimg
    }
    })
    
    audio.addEventListener("timeupdate", (e) => {
    const current = Math.floor(audio.currentTime)
    const duration = Math.round(audio.duration)
    if (!isNaN(duration)) {
        document.getElementById('Musictime').innerHTML = playTime(current)
        const percent = Math.round((audio.currentTime/audio.duration)*1000)/10
        document.getElementById('seekbar').style.backgroundSize = percent + '%'
    }
    })
    
    document.getElementById('seekbar').addEventListener("click", (e) => {
    const duration = Math.round(audio.duration)
        if(!isNaN(duration)){
            const mouse = e.pageX
            const element = document.getElementById('seekbar')
            const rect = element.getBoundingClientRect()
            const position = rect.left + window.pageXOffset
            const offset = mouse - position
            const width = rect.right - rect.left
            audio.currentTime = Math.round(duration * (offset / width))
        }
    })
    
    function playTime (t) {
        let hms = ''
        const h = t / 3600 | 0
        const m = t % 3600 / 60 | 0
        const s = t % 60
        const z2 = (v) => {
        const s = '00' + v
        return s.substr(s.length - 2, 2)
        }
        if(h != 0){
        hms = h + ':' + z2(m) + ':' + z2(s)
        }else if(m != 0){
        hms = z2(m) + ':' + z2(s)
        }else{
        hms = '00:' + z2(s)
        }
        return hms
    }
</script>
{% endif %}
<script>

    let original_flg = '{{ is_original }}'.toLocaleLowerCase();
    const async_star = ()=>{//評価の非同期処理
        const login = JSON.parse( '{{ request.user.is_authenticated }}'.toLowerCase() );
        if( !login ) return;
        for( let i = 0;i < document.getElementsByClassName( 'eval-btn' ).length;i ++ ){
            document.getElementsByClassName( 'eval-btn' )[ i ].addEventListener( 'click', ( e )=>{
                e.preventDefault();//ページ遷移処理を止める
                const url = '{% url "star" track_result.id %}';
                const data = {
                    number: i
                };
                fetch( url, {
                    method: 'POST',
                    body: `star_n=${JSON.stringify( data )}`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                } ).then( response => {
                    return response.json();
                } ).then( response => {
                    init_star( response.ave_star, response.user_star );
                } ).catch( error => {
                    console.log( error );
                } )
            } )
        }
    }
    const async_comment_good = ()=>{
        if( !original_flg ) return;
        for( let i = 0;i < document.getElementsByClassName( 'good-img-button' ).length;i ++ ){
            document.getElementsByClassName( 'good-img-button' )[ i ].addEventListener( 'click', ( e )=>{
                e.preventDefault();
                const url = '{% url "good_comment" 0 %}';
                let nurl = url.replace( '0', document.getElementsByClassName( 'good-img-button' )[ i ].dataset.comment_id );
                const data = {
                    content:''
                }
                fetch( nurl, {
                    method: 'POST',
                    body: `comment_good_n=${JSON.stringify( data )}`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                }).then( response => {
                    return response.json();
                } ).then( response => {
                    init_comment_good( response.gc_count, response.gc_bool, i );
                } ).catch( error => {
                    console.log( error );
                } )
            } )
        }
    }
    const init_star = ( a = '{{ ave_star }}', u = '{{ user_star }}' )=>{//評価の非同期時のDOM操作
        const a_s = a;
        const u_s = u;
        const star_img_green = "<img src='{% static 'img/tmp/star_green.png' %}'>";
        const star_img_linegreen = "<img src='{% static 'img/tmp/greenlinestar.png' %}'>"
        const star_img_black = "<img src='{% static 'img/tmp/star_black.png' %}'>";
        let ver_arr = new Array( 5 );
        for( let i = 0;i < 5;i ++ ){
            let sp = document.createElement( 'span' );
            sp.setAttribute( 'class', 'eval-btn' );
            if( i < a_s && i < u_s ){
                sp.innerHTML = star_img_green;
                ver_arr[ i ] = sp.outerHTML;
                continue;
            }else if( i < a_s ){
                sp.innerHTML = star_img_linegreen;
                ver_arr[ i ] = sp.outerHTML;
                continue;
            }else if( i < u_s ){
                sp.innerHTML = star_img_green;
                ver_arr[ i ] = sp.outerHTML;
                continue;
            }else{
                sp.innerHTML = star_img_black;
                ver_arr[ i ] = sp.outerHTML;
            }
        }
        document.querySelector( '.stars' ).innerHTML = '<span class="eval">評価</span><br>';
        for( let i = 0;i < 5;i ++ ){
            document.querySelector( '.stars' ).innerHTML += ver_arr[ i ];
        }
        document.querySelector( '.stars' ).innerHTML += `<br><span class="eval-num">みんなの評価:${ a }/5</span>`;
        setTimeout( async_star, 1000 );
    }
    const init_comment_good = ( count, bool, n ) => {
        const good_before = "{% static 'img/tmp/good_black.png' %}";
        const good_after = "{% static 'img/tmp/good_white.png' %}";
        document.getElementsByClassName( 'gc-count' )[ n ].textContent = count;
        
        document.getElementsByClassName( 'good-img-button' )[ n ].src = ( bool == 'true' ? good_after : good_before );
    }
    const good_eval = () => {
    document.getElementById('good-btn').addEventListener('click', (e) => {
      e.preventDefault(); // Prevent page navigation
      const url = '{% url "good" track_result.id %}';
      const data = {
        number: ""
      };
      fetch(url, {
          method: 'POST',
          body: `good_n=${JSON.stringify(data)}`,
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
            'X-CSRFToken': '{{ csrf_token }}',
          },
        }).then(response => {
          return response.json();
        }).then(response => {
            init_good(response.good_count,response.good_bool);
        }).catch(error => {
          console.log(error);
        });
    });
  }

  const init_good = ( u = '{{good_count}}', b = '{{good_bool}}' ) => {
  const good_img_black = "<img src='{% static 'img/tmp/heart_black.png'%}'>";
  const good_img_green = "<img src='{% static 'img/tmp/heart_green.png' width: 30px; padding-top: 8px;%}'>";
  let ver = new Array( 2 );
  let button = document.createElement('span');
    button.setAttribute('id', 'good-btn',);
        if ( b == "True" || b == 'true'){
            button.innerHTML = good_img_green;
            ver[1] = button.outerHTML;
        }else{
            button.innerHTML = good_img_black;
            ver[1] = button.outerHTML;
        }
        document.querySelector( '.good' ).innerHTML ='<span class = eval>いいね</span>';
        document.querySelector( '.good' ).innerHTML += ver[ 1 ];
        document.querySelector( '.good' ).innerHTML += `<span class = good_nums>${ u }</span>`;
        setTimeout( good_eval, 1000 );
}
    const view_reply = ( n, res ) => {
        if( res.len == 0 ){
            alert( '返信はありません' );
            return ;
        }
        const obj = document.getElementsByClassName( 'reply' )[ n ];
        document.querySelectorAll( '.a-reply' )[ n ].style.display = 'none';
        //const nres = JSON.parse( res.contents );
        for( let i = 0;i < res.len;i ++ ){
            const container = document.createElement( 'div' );
            container.setAttribute( 'class', 'rep-container' );
            const title_container = document.createElement( 'div' );
            title_container.setAttribute( 'class', 'rep-title-container' );
            const content_container = document.createElement( 'div' );
            content_container.setAttribute( 'class', 'rep-content-container' );
            const rep_name = `<div class="rep-name">${ res.contents[ i ].user_name }</div>`;
            const rep_image = `<div class="rep-image"><img src="${ res.contents[ i ].user_image }" alt="アイコン" width="50" height="50"></div>`;
            const rep_good = `<div class="rep-good"><p>　　　</p></div>`;
            let restext = res.contents[ i ].reply_text;
            restext = restext.split( /\n/ );
            let str = '';
            for( let j = 0;j < restext.length;j ++ ){
                str += (restext[ j ] + '<br>');
            }
            //const rep_text = `<div class="rep-text">${ res.contents[ i ].reply_text + '\t登校日:' + res.contents[ i ].reply_posted }</div>`;
            const rep_text = `<div class="rep-text">${ str + '\t投稿日:' + res.contents[ i ].reply_posted }</div>`;
            title_container.innerHTML += rep_image + rep_name;
            content_container.innerHTML += rep_good + rep_text;
            container.innerHTML += title_container.outerHTML + content_container.outerHTML;
            obj.appendChild( container );
        }
    }
    const async_view_reply = () => {//返信表示の非同期処理
        for( let i = 0;i < document.getElementsByClassName( 'reply' ).length;i ++ ){
            document.querySelectorAll( '.reply > a' )[ i ].addEventListener( 'click', ( e )=>{
                e.preventDefault();
                const url = '{% url "view_reply" 0 %}'.replace( '0', document.querySelectorAll( '.reply > a' )[ i ].dataset.comment_id );
                const data = {
                    content: '',
                }
                fetch( url, {
                    method: 'POST',
                    body: `content=${ JSON.stringify( data ) }`,
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=utf-8',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                } ).then( response => {
                    return response.json();
                } ).then( response => {
                    view_reply( i, response );
                } ).catch( error => {
                    console.log( error );
                } )
            } );
        }
    }
    window.onSpotifyIframeApiReady = ( IFrameAPI ) => {
        init_star();
        init_good();
        async_comment_good();
        setTimeout( async_view_reply, 1000 );
        const flg = JSON.parse( '{{ request.user.is_authenticated }}'.toLowerCase() );
        if( flg ){
            document.getElementById( 'id_comment_text' ).placeholder = 'コメント';
        }
        if( '{{ track_result.uri }}' == 'None' ) return;
        const elem = document.getElementById( 'spotify-iframe' );
        const options = {
            width: '95%',
            height: '700',
            uri: '{{ track_result.uri }}'
        }
        const callback = ( EmbedController ) => {
            EmbedController.addListener('ready', () => {
                loading.classList.add( 'loaded' );
            }, false );
        }
        IFrameAPI.createController( elem, options, callback );
    }
    /*window.onload = (  ) => {
        if( !original_flg ) return ;
        let ms = new PreviewMusic( '/media_local/{{ track_result.full_url }}', '.playbtn', 0 );
        document.querySelector( '.playbtn' ).onclick = ( e ) => {
            if( ms.is_play ){
                ms.stop();
            }else{
                ms.play();
            }
        }
    }*/
    for( let i = 0;i < document.getElementsByClassName( 'menu' ).length;i ++ ){//ログインしてないとedit-actionがなくてバグる
        document.getElementsByClassName( 'menu' )[ i ].addEventListener( 'click', ( e )=>{
            if (document.getElementsByClassName('cmt-edit')[i].className == 'cmt-edit cmt-edit-on'){
                document.getElementsByClassName('cmt-edit')[i].className = 'cmt-edit';
            }else{
                document.getElementsByClassName('cmt-edit')[i].classList.add('cmt-edit-on');
            }
        });
    }
</script>
{% endblock %}